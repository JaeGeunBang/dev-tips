### BigQuery

<hr>


빅쿼리 정의

- BigQuery is **fully-managed enterprise data warehouse** that enable super-fast SQL queries.




빅데이터 처리의 문제점

- Scaling infrastructure
- Finding critical

- Optimizating costs



**특징**

- google cloud의 엔터프라이즈 데이터 웨어하우스
- 표준 SQL 사용
  - SQL 2011 + extension을 사용. 늘 사용하던 DB language를 그대로 사용한다.
- 완전 관리 및 서버리스 (사용자가 인프라 관리를 할 필요가 없다)
  - 기존 데이터웨어 하우스와 달리 분석에 100% 시간을 쏟을 수 있다.
- 페타 바이트 급 스토리지 및 쿼리
- 암호화, 내구성 및 높은 가용성

- 테이블은 최적화된 컬럼 형식으로 저장되며, 자동으로 디스크에 압축되고 암호화 된다.
  - 각 컬럼 별로 분리, 압축, 암호화되며, 인덱스, 키 등이 필요하지 않는다.
  - OLAP 성의 분석에 최적화 되어 있다.
- 복잡한 쿼리도 빠르게 수행한다.
  - 내부적으로 최대 2,000개의 slot 중 1,030개가 동적 사용됨
  - 스토리지 디스크에서 약 4TB 용량을 처리함
  - 소요된 비용은 20달러
- CPU, Storage Cluster가 구분되어 있다.
  - 둘 사이에 jupiter (네트워크)로 연결되어 있다.
- GIS 처리가 가능하다. (지리 정보)
  - bigquery가 유일. Socar, Tada 같은데서 사용
- 복제가 아닌 공유를 한다.
  - 기존 방식은 데이터를 엑셀 형식으로 타팀에 복제하는 형식. 만약 변경된 데이터를 다시 복제해주어야 한다.
  - bigquery는 storage랑 CPU가 나뉘어져 있기 때문에, storage를 전체 팀에 공유하고 관련 권한만 부여해 주면 된다.



**가격**

- 기본 가격
  - 저장: 1TB 당 월 20달러
  - 장기 저장 (90일 이상): 1TB 당 월 10달러 (반값 할인)
    - SELECT는 해도 상관없음. Append, insert만 없으면 알아서 장기 저장 된다.
  - 쿼리: 1TB 당 5달러. 스캔 비용이며 CPU에 대한 비용은 들지 않는다.

- 캐시된 테이블을 활용하면 더 빠르게 쿼리를 수행하며, 비용이 발생하지 않는다.
  - 최초 한번만 비용을 받고, 이후엔 비용을 받지 않는다.
  - 최초 쿼리 발생 후 모두 캐시에 저장됨.
  - 단, 똑같은 쿼리를 날렸을 때.
- 정액제, 팀별 quetos를 제공하기 때문에 마음껏 분석할 수 있음.



**최적화**

Table Sharding

- 좀더 빠른 성능을 원할때 sharding을 사용한다.
  - 테이블 저장할 때 날짜 별로 저장하면, bigquery가 알아서 sharding 해준다.
- 불필요한 쿼리 비용을 줄이고 더 빠른 성능을 만들 수 있다.

Partitioning

- Sharding 해둔 테이블을 partition 할 수 있다.

Clustering

- high-cardinality field에 사용한다. (보통 unique 한 key들을 뜻함.)
- 게임회사같은 경우는 user id 기반으로 clustering을 해둔다.



**데이터 구조**

- Project 별로 Dataset - Table 1, 2... 으로 구분할 수 있다.
  - BigQuery의 Dataset은 Db의 database과 대칭
  - BigQuery의 Table은 Db의 Table과 대칭
- 일반 DB와 유사한 구조로 사용한다.



**데이터 로딩**

- CSV, JSON, AVRO, Parquet, ORC 등 bq tool을 통해 데이터를 수집할 수 있다.
- 다양한 서버에서 로그를 수집하고 싶을 때. Stackdriver Logging을 사용한다.
  - 클라우드 뿐만 아니라 on-premise 서버 로그도 수집할 수 있다.
- ETL 도구
  - Beam ?
  - Dataflow ?
  - Data Fusion (aka Nifi)
    - 데이터 파이프 라인 개발하고 싶을때. 코딩할 필요 없음
    - 계속 떠있어야 하는 단점은 있음.
    - 실제 데이터를 보고 변환,정제 (필요없는 것은 빼거나.. 밑단은 자동으로 Spark로 처리) 가능
- 분석을 위한 Datalake로서 사용된다.
  - Firebase Export, GA export, youbute, s3 등 다양한 data source로 부터 수집할 수 있다.



**데이터 시각화**

- Democratizes Data Insights
- Sheets가 Bigquery에 바로 붙어서 데이터를 가져올 수 있다.
  - bigquery에 대한 결과를 csv, sheets 형식으로 저장할수도 있다.
- Data Studio는 무상으로 제공됨.



DB (BigTable) - NoSQL

- OLAP 성 쿼리로 빠른 latency

DW (BigQuery) = Hive 와 거의 유사.

- throughput 즉, 분석에 좀더 초점을 맞춤